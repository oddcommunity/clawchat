apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: clawchat-ingress
  namespace: clawchat
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    # Enable WebSocket support for Matrix
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$binary_remote_addr"
spec:
  tls:
    - hosts:
        - matrix.clawchat.io
        - api.clawchat.io
      secretName: clawchat-tls
  rules:
    # Matrix Synapse endpoints
    - host: matrix.clawchat.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: synapse
                port:
                  number: 8008

    # Clawdbot API (if needed for webhooks, health checks, etc.)
    - host: api.clawchat.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: clawdbot
                port:
                  number: 3000
---
# Well-known configuration for Matrix federation (if enabled later)
apiVersion: v1
kind: ConfigMap
metadata:
  name: well-known-config
  namespace: clawchat
data:
  server: |
    {
      "m.server": "matrix.clawchat.io:443"
    }
  client: |
    {
      "m.homeserver": {
        "base_url": "https://matrix.clawchat.io"
      }
    }
