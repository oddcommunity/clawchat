apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: synapse-data-pvc
  namespace: clawchat
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: standard
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: synapse-config
  namespace: clawchat
data:
  homeserver.yaml: |
    server_name: "clawchat.io"
    pid_file: /data/homeserver.pid
    public_baseurl: https://matrix.clawchat.io/

    listeners:
      - port: 8008
        tls: false
        type: http
        x_forwarded: true
        resources:
          - names: [client, federation]
            compress: false

    database:
      name: psycopg2
      args:
        user: synapse
        password: "${POSTGRES_PASSWORD}"
        database: synapse
        host: postgres
        port: 5432
        cp_min: 5
        cp_max: 10

    log_config: "/data/clawchat.io.log.config"
    media_store_path: /data/media_store

    registration_shared_secret: "${SYNAPSE_REGISTRATION_SHARED_SECRET}"
    enable_registration: false
    enable_registration_without_verification: false

    macaroon_secret_key: "${SYNAPSE_MACAROON_SECRET_KEY}"
    form_secret: "${SYNAPSE_FORM_SECRET}"
    signing_key_path: "/data/clawchat.io.signing.key"

    trusted_key_servers: []
    federation_domain_whitelist: []

    rc_message:
      per_second: 10
      burst_count: 50
    rc_registration:
      per_second: 0.5
      burst_count: 5
    rc_login:
      address:
        per_second: 1
        burst_count: 10
      account:
        per_second: 1
        burst_count: 10

    caches:
      global_factor: 1.0
      per_cache_factors:
        stateGroupCache: 2.0

    redis:
      enabled: true
      host: redis
      port: 6379
      password: "${REDIS_PASSWORD}"

    presence:
      enabled: false

    suppress_key_server_warning: true
    report_stats: false
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: synapse
  namespace: clawchat
spec:
  replicas: 1
  selector:
    matchLabels:
      app: synapse
  template:
    metadata:
      labels:
        app: synapse
    spec:
      initContainers:
        - name: generate-config
          image: matrixdotorg/synapse:latest
          command:
            - sh
            - -c
            - |
              if [ ! -f /data/clawchat.io.signing.key ]; then
                python -m synapse.app.homeserver \
                  --server-name clawchat.io \
                  --config-path /tmp/homeserver.yaml \
                  --generate-keys \
                  --keys-directory /data
              fi
          volumeMounts:
            - name: synapse-data
              mountPath: /data
      containers:
        - name: synapse
          image: matrixdotorg/synapse:latest
          ports:
            - containerPort: 8008
          env:
            - name: SYNAPSE_CONFIG_PATH
              value: /config/homeserver.yaml
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: clawchat-secrets
                  key: POSTGRES_PASSWORD
            - name: SYNAPSE_REGISTRATION_SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: clawchat-secrets
                  key: SYNAPSE_REGISTRATION_SHARED_SECRET
            - name: SYNAPSE_MACAROON_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: clawchat-secrets
                  key: SYNAPSE_MACAROON_SECRET_KEY
            - name: SYNAPSE_FORM_SECRET
              valueFrom:
                secretKeyRef:
                  name: clawchat-secrets
                  key: SYNAPSE_FORM_SECRET
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: clawchat-secrets
                  key: REDIS_PASSWORD
          volumeMounts:
            - name: synapse-config
              mountPath: /config
            - name: synapse-data
              mountPath: /data
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8008
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 8008
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: synapse-config
          configMap:
            name: synapse-config
        - name: synapse-data
          persistentVolumeClaim:
            claimName: synapse-data-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: synapse
  namespace: clawchat
spec:
  selector:
    app: synapse
  ports:
    - name: http
      port: 8008
      targetPort: 8008
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: synapse-hpa
  namespace: clawchat
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: synapse
  minReplicas: 1
  maxReplicas: 5
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
